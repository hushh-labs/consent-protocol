# api/routes/health.py
"""
Health check endpoints.
"""

import logging
import os

from fastapi import APIRouter, HTTPException, Request

from api.middlewares.rate_limit import limiter
from api.utils.firebase_admin import ensure_firebase_admin

logger = logging.getLogger(__name__)

router = APIRouter(tags=["Health"])


def _env_truthy(name: str, fallback: str = "false") -> bool:
    raw = str(os.getenv(name, fallback)).strip().lower()
    return raw in {"1", "true", "yes", "on"}


def _is_app_review_mode_enabled() -> bool:
    return _env_truthy("APP_REVIEW_MODE") or _env_truthy("HUSHH_APP_REVIEW_MODE")


@router.get("/")
def health_check():
    """Root health check."""
    return {"status": "ok", "service": "hushh-consent-protocol"}


@router.get("/health")
def health():
    """Detailed health check with agent list."""
    return {"status": "healthy", "agents": ["kai"]}


@router.get("/api/app-config/review-mode")
def app_review_mode_config():
    """Runtime app-review-mode config served from backend env (not frontend build env)."""
    return {"enabled": _is_app_review_mode_enabled()}


@router.post("/api/app-config/review-mode/session")
@limiter.limit("10/minute")
async def issue_app_review_mode_session(request: Request):
    """
    Mint a Firebase custom token for app-review login.

    Security:
    - Enabled only when APP_REVIEW_MODE/HUSHH_APP_REVIEW_MODE is true
    - Uses fixed REVIEWER_UID from server env
    - Never returns reviewer password to clients
    """
    if not _is_app_review_mode_enabled():
        raise HTTPException(status_code=403, detail="App review mode is disabled")

    reviewer_uid = str(os.getenv("REVIEWER_UID", "")).strip()
    if not reviewer_uid:
        logger.error("app_review_mode.session_failed reason=missing_reviewer_uid")
        raise HTTPException(status_code=503, detail="Reviewer identity not configured")

    configured, project_id = ensure_firebase_admin()
    if not configured:
        logger.error("app_review_mode.session_failed reason=firebase_admin_not_configured")
        raise HTTPException(status_code=503, detail="Firebase Admin not configured")

    try:
        from firebase_admin import auth as firebase_auth

        custom_token = firebase_auth.create_custom_token(reviewer_uid)
        token_str = (
            custom_token.decode("utf-8") if isinstance(custom_token, bytes) else str(custom_token)
        )
    except Exception as e:
        logger.exception("app_review_mode.session_failed reason=token_mint_error error=%s", e)
        raise HTTPException(status_code=500, detail="Failed to issue review session token")

    client_ip = request.client.host if request.client else "unknown"
    logger.info(
        "app_review_mode.session_issued reviewer_uid=%s project_id=%s client_ip=%s",
        reviewer_uid,
        project_id or "unknown",
        client_ip,
    )
    return {"token": token_str}

name: Deploy to Production

on:
  push:
    branches:
      - deploy
  workflow_dispatch:

env:
  GCP_PROJECT_ID: hushh-pda
  GCP_REGION: us-central1
  BACKEND_SERVICE: consent-protocol
  FRONTEND_SERVICE: hushh-webapp

jobs:
  deploy-backend:
    name: Deploy Backend to Production
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Deploy backend using Cloud Build
        run: |
          gcloud builds submit \
            --config=deploy/backend.cloudbuild.yaml

      - name: Get backend URL
        id: backend-url
        run: |
          BACKEND_URL=$(gcloud run services describe ${{ env.BACKEND_SERVICE }} \
            --region=${{ env.GCP_REGION }} \
            --format='value(status.url)')
          echo "url=$BACKEND_URL" >> $GITHUB_OUTPUT
          echo "Backend URL: $BACKEND_URL"

    outputs:
      backend_url: ${{ steps.backend-url.outputs.url }}

  deploy-frontend:
    name: Deploy Frontend to Production
    runs-on: ubuntu-latest
    needs: deploy-backend

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Deploy frontend using Cloud Build
        run: |
          gcloud builds submit \
            --config=deploy/frontend.cloudbuild.yaml

      - name: Get frontend URL
        id: frontend-url
        run: |
          FRONTEND_URL=$(gcloud run services describe ${{ env.FRONTEND_SERVICE }} \
            --region=${{ env.GCP_REGION }} \
            --format='value(status.url)')
          echo "url=$FRONTEND_URL" >> $GITHUB_OUTPUT
          echo "Frontend URL: $FRONTEND_URL"

      - name: Deployment Summary
        run: |
          echo "âœ… Production Deployment Complete"
          echo "Backend: ${{ needs.deploy-backend.outputs.backend_url }}"
          echo "Frontend: ${{ steps.frontend-url.outputs.url }}"

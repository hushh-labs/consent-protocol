name: "Consent Protocol CI"

on:
  push:
    branches: ["**"]
  pull_request:
    branches: ["**"]
  merge_group:
    branches: [main]
  workflow_dispatch: {}

permissions:
  contents: read

concurrency:
  group: ci-${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  PYTHON_VERSION: "3.13"
  GITLEAKS_VERSION: "8.24.2"

jobs:
  # ============================================================================
  # Secret scan: gitleaks OSS CLI (license-free)
  # ============================================================================
  secret-scan:
    name: "Secret Scan"
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install gitleaks OSS CLI (license-free)
        run: |
          curl -sSL "https://github.com/gitleaks/gitleaks/releases/download/v${{ env.GITLEAKS_VERSION }}/gitleaks_${{ env.GITLEAKS_VERSION }}_linux_x64.tar.gz" \
            | tar -xz
          sudo mv gitleaks /usr/local/bin/gitleaks
          gitleaks version

      - name: Resolve scan commit range
        id: scan-range
        shell: bash
        run: |
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            LOG_OPTS="${{ github.event.pull_request.base.sha }}..${{ github.event.pull_request.head.sha }}"
          elif [ "${{ github.event_name }}" = "push" ] && [ "${{ github.event.before }}" != "0000000000000000000000000000000000000000" ]; then
            LOG_OPTS="${{ github.event.before }}..${{ github.sha }}"
          elif [ "${{ github.event_name }}" = "push" ]; then
            DEFAULT_BRANCH="${{ github.event.repository.default_branch }}"
            git fetch origin "$DEFAULT_BRANCH" --quiet || true
            if git rev-parse "origin/$DEFAULT_BRANCH" >/dev/null 2>&1; then
              LOG_OPTS="origin/$DEFAULT_BRANCH..${{ github.sha }}"
            else
              LOG_OPTS="${{ github.sha }}"
            fi
          else
            LOG_OPTS="${{ github.sha }}"
          fi
          echo "log_opts=$LOG_OPTS" >> "$GITHUB_OUTPUT"

      - name: Run gitleaks scan
        run: gitleaks git --redact --no-banner --exit-code 1 --log-opts="${{ steps.scan-range.outputs.log_opts }}"

  # ============================================================================
  # Lint: ruff check + format verification
  # ============================================================================
  lint:
    name: "Lint (ruff)"
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: "pip"
          cache-dependency-path: requirements.txt

      - name: Install dev dependencies
        run: python -m pip install --upgrade pip && python -m pip install -r requirements-dev.txt

      - name: Lint with ruff
        run: python -m ruff check .

      - name: Check formatting with ruff
        run: python -m ruff format --check .

  # ============================================================================
  # Type check: mypy
  # ============================================================================
  typecheck:
    name: "Type Check (mypy)"
    runs-on: ubuntu-latest
    timeout-minutes: 20
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: "pip"
          cache-dependency-path: requirements.txt

      - name: Install dependencies
        timeout-minutes: 10
        run: |
          python -m pip install --upgrade pip
          python -m pip install -r requirements.txt
          python -m pip install -r requirements-dev.txt

      - name: Type check with mypy
        run: python -m mypy --config-file pyproject.toml --ignore-missing-imports

  # ============================================================================
  # Tests: pytest with coverage
  # ============================================================================
  test:
    name: "Test (pytest)"
    runs-on: ubuntu-latest
    timeout-minutes: 25
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: "pip"
          cache-dependency-path: requirements.txt

      - name: Install dependencies
        timeout-minutes: 10
        run: |
          python -m pip install --upgrade pip
          python -m pip install -r requirements.txt
          python -m pip install -r requirements-dev.txt

      - name: Run tests with coverage
        timeout-minutes: 10
        run: python -m pytest tests/ -v --tb=short --cov=hushh_mcp --cov-report=xml --cov-report=term
        env:
          TESTING: "true"
          SECRET_KEY: "test_secret_key_for_ci_only_32chars_min"
          VAULT_ENCRYPTION_KEY: "0000000000000000000000000000000000000000000000000000000000000000"
          MCP_DEVELOPER_TOKEN: "test_mcp_developer_token_for_ci"

  # ============================================================================
  # Security: bandit static analysis
  # ============================================================================
  security:
    name: "Security (bandit)"
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install bandit
        run: python -m pip install --upgrade pip && python -m pip install bandit>=1.7.6

      - name: Security scan
        run: python -m bandit -r hushh_mcp/ api/ -c pyproject.toml -ll

  # ============================================================================
  # Docker: verify Dockerfile builds
  # ============================================================================
  docker:
    name: "Docker Build"
    runs-on: ubuntu-latest
    timeout-minutes: 20
    steps:
      - uses: actions/checkout@v4

      - name: Build Docker image
        run: docker build -t consent-protocol:ci .

  ci-status:
    name: "CI Status Gate"
    needs:
      - secret-scan
      - lint
      - typecheck
      - test
      - security
      - docker
    if: always()
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - name: Validate job outcomes
        shell: bash
        run: |
          SECRET_SCAN="${{ needs['secret-scan'].result }}"
          LINT="${{ needs.lint.result }}"
          TYPECHECK="${{ needs.typecheck.result }}"
          TEST="${{ needs.test.result }}"
          SECURITY="${{ needs.security.result }}"
          DOCKER="${{ needs.docker.result }}"

          printf 'secret-scan=%s\n' "$SECRET_SCAN"
          printf 'lint=%s\n' "$LINT"
          printf 'typecheck=%s\n' "$TYPECHECK"
          printf 'test=%s\n' "$TEST"
          printf 'security=%s\n' "$SECURITY"
          printf 'docker=%s\n' "$DOCKER"

          fail=0
          for result in "$SECRET_SCAN" "$LINT" "$TYPECHECK" "$TEST" "$SECURITY" "$DOCKER"; do
            if [ "$result" = "failure" ] || [ "$result" = "cancelled" ] || [ "$result" = "timed_out" ]; then
              fail=1
            fi
          done

          if [ "$fail" -ne 0 ]; then
            echo "One or more CI jobs failed."
            exit 1
          fi
          echo "All required CI jobs passed."

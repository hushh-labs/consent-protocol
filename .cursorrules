# Hushh Project - AI Assistant Rules

## CRITICAL: Tri-Flow Architecture (Capacitor)

This is a Capacitor app that runs on Web, iOS, and Android.
**Native platforms have NO Next.js server at runtime.**

### BANNED PATTERNS

❌ NEVER write `fetch("/api/...")` in:
- Components (`app/**/*.tsx`, `components/**/*.tsx`)
- Pages (`app/**/page.tsx`)

Exception: Only API routes themselves (`app/api/**/route.ts`) can use fetch().

### REQUIRED PATTERNS

✅ ALWAYS use service layer:
```typescript
// In components
import { ApiService } from '@/lib/services/api-service';
const response = await ApiService.method();
```

### NEW FEATURE CHECKLIST

When creating any feature that accesses data:

1. **Backend** → Create Python endpoint in `consent-protocol/api/routes/`
2. **Web Proxy** → Create Next.js route in `hushh-webapp/app/api/`
3. **iOS Plugin** → Add Swift method in `ios/App/App/Plugins/`
4. **Android Plugin** → Add Kotlin method in `android/.../plugins/`
5. **Service** → Create platform detector in `lib/services/`
6. **Component** → Use service method (NOT fetch)
7. **Plugin Registration** → Register iOS plugin in `ios/App/App/MyViewController.swift` and Android plugin in `android/.../MainActivity.kt`

ALL 7 must exist or feature is incomplete.

### BEFORE SUGGESTING CODE

1. Check if service method exists
2. If not, flag that all 3 platform implementations are needed
3. Never suggest `fetch()` in components
4. Always suggest service-layer pattern

### COMMON MISTAKES TO AVOID

- Assuming Next.js server exists at runtime (it doesn't on native)
- Forgetting native plugins when creating API routes
- Using fetch() directly in React components
- Not checking platform in service methods

## CRITICAL: XSS Protection (Memory-Only Token Storage)

**SECURITY RULE**: Vault key AND VAULT_OWNER token are stored ONLY in React state (memory).

### BANNED PATTERNS

❌ NEVER store sensitive tokens in sessionStorage:
```typescript
// WRONG - XSS vulnerability!
sessionStorage.setItem("vault_owner_token", token);
const token = sessionStorage.getItem("vault_owner_token");
```

❌ NEVER read token from sessionStorage in services:
```typescript
// WRONG - Services should receive token as parameter
static getVaultOwnerToken(): string | null {
  return sessionStorage.getItem("vault_owner_token");
}
```

### REQUIRED PATTERNS

✅ Store tokens in React state only:
```typescript
// In VaultContext - memory only
const [vaultOwnerToken, setVaultOwnerToken] = useState<string | null>(null);
```

✅ Pass token explicitly from useVault() hook:
```typescript
// In component
const { vaultOwnerToken } = useVault();
await AccountService.deleteAccount(vaultOwnerToken);

// In service - token is REQUIRED parameter
async deleteAccount(vaultOwnerToken: string): Promise<Result> {
  if (!vaultOwnerToken) throw new Error("Token required");
  // Use token...
}
```

### WHAT CAN BE IN sessionStorage (non-sensitive only)

- `vault_unlocked` - Boolean flag ("true")
- `user_id` - Firebase UID (public identifier)

### WHAT MUST NEVER BE IN sessionStorage

- `vault_key` - Encryption key
- `vault_owner_token` - Consent token
- Any cryptographic material

### DOCUMENTATION REFERENCES

- Tri-flow rules: `docs/project_context_map.md`
- Feature checklist: `docs/guides/feature_checklist.md`
- Route contracts: `docs/reference/route_contracts.md`
- Component guidelines: `hushh-webapp/components/README.md`

## ENFORCEMENT

ESLint will catch `fetch()` violations in components automatically.
Always run `npm run lint` before committing.

## Branching Convention

**REQUIRED FORMAT:** `/[username]/[type]/[type-name]`

- `[username]` - GitHub username (lowercase, no spaces)
- `[type]` - One of: `feat`, `fix`, `docs`, `refactor`, `test`, `chore`
- `[type-name]` - Descriptive name (kebab-case)

Examples:
- ✅ `john/feat/add-movie-agent`
- ✅ `jane/fix/vault-unlock-race-condition`
- ✅ `alice/docs/update-readme`
- ❌ `feat/add-movie-agent` (missing username)
- ❌ `john/add-movie-agent` (missing type)

**Enforcement:**
- Always suggest branch names in the `/[username]/[type]/[type-name]` format
- Never suggest branches starting with `feat/`, `fix/`, or `docs/` without username prefix
- When user asks to create a branch, prompt for their GitHub username if not provided

## Documentation Assumptions

**CRITICAL:** AI agents must verify assumptions before treating them as fact.

### Verified Information
- Contact email: `eng@hush1one.com` (all contact emails)
- Database: Supabase REST API (not Cloud SQL)
- Branch format: `/[username]/[type]/[type-name]`

### Common Assumptions to Flag
- **Email addresses**: All contact emails should be `eng@hush1one.com` (not `@hushh.ai`)
- **URLs**: External API URLs (`api.hushh.ai`, `docs.hushh.ai`) should reference local documentation paths
- **GCP Projects**: Never reference internal GCP project IDs (`hushh-pda`) - use placeholders
- **Database**: Use Supabase REST API, not Cloud SQL connection strings
- **Branch names**: Always use `/[username]/[type]/[type-name]` format

### Before Using Information
1. Check if value is a placeholder or example
2. Verify against `docs/assumptions_audit.md` if it exists
3. Flag assumptions with `<!-- ASSUMPTION: [description] -->` comments when uncertain
4. Prefer local documentation references over external URLs

## AI Sign-Off and Token Usage (Required from now on)

**CRITICAL:** All AI-assisted work must include sign-off and, when available, token usage for transparency and cost awareness.

### Git commits
When creating or suggesting a commit, **always** append to the commit message body:
1. **Sign-off line:**
   ```
   Signed-off-by: [AI Provider Name] <[identifier]>
   ```
   Example: `Signed-off-by: Cursor AI (Claude) <ai@cursor.com>`
2. **Token usage** (when the environment provides it, e.g. Cursor/IDE):
   ```
   Tokens used: [input/output or total as provided]
   ```
   Use the actual provider name (e.g. Cursor AI, Claude, GPT, etc.). If token counts are not available, omit the Tokens used line but always include Signed-off-by.

### Responses
When completing a task or finishing a substantive response, **always** include at the end:
1. A one-line sign-off: `Signed-off-by: [AI model provider name]` (e.g. `Signed-off-by: Cursor AI (Claude)`).
2. Token usage when available: `Tokens used: [as provided by environment]`.

## Subagent Delegation

This project uses specialized Cursor subagents for domain-specific expertise. Delegate to the appropriate subagent for better context and reduced hallucinations.

### Available Subagents

| Domain | Subagent | When to Use |
|--------|----------|-------------|
| Security/Consent | `/compliance-auditor` | Any code touching user data, auth flows, GDPR/CCPA |
| Platform Parity | `/tri-flow-validator` | Creating API routes, plugins, or data-access features |
| Documentation | `/docs-specialist` | Finding specs, architecture details, onboarding info |
| Frontend | `/frontend-architect` | React, Next.js, Capacitor, Morphy-UX components |
| Backend | `/backend-architect` | Python, FastAPI, services, database operations |
| AI Agents | `/agent-developer` | HushhAgent, ADK tools, Kai debate framework |
| Validation | `/verifier` | Before marking tasks complete, PR reviews |
| New Contributors | `/onboarding-guide` | Setup, project structure, first issues |

### Automatic Delegation Triggers

- **Security code** → Always invoke `/compliance-auditor`
- **New feature** → Always invoke `/tri-flow-validator` to check 6-step completeness
- **Task complete** → Always invoke `/verifier` before marking done

### Subagent Files

All subagents are defined in `.cursor/agents/`:
- `compliance-auditor.md` - Security and consent enforcement
- `tri-flow-validator.md` - Platform parity validation
- `docs-specialist.md` - Documentation navigation
- `frontend-architect.md` - React/Next.js/Capacitor
- `backend-architect.md` - Python/FastAPI/ADK
- `agent-developer.md` - HushhAgent development
- `verifier.md` - Implementation validation
- `onboarding-guide.md` - New contributor helper

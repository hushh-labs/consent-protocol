# Cloud Build configuration for Python FastAPI backend
# Trigger: Push to main branch or manual trigger
# Deploy to: Cloud Run (consent-protocol service)

steps:
  # Step 1: Build Docker image
  - name: "gcr.io/cloud-builders/docker"
    args:
      - "build"
      - "-t"
      - "gcr.io/$PROJECT_ID/consent-protocol:manual"
      - "-t"
      - "gcr.io/$PROJECT_ID/consent-protocol:latest"
      - "-t"
      - "gcr.io/$PROJECT_ID/consent-protocol:v2.1.0"
      - "-f"
      - "consent-protocol/Dockerfile"
      - "consent-protocol"
    id: "build-backend-image"

  # Step 2: Push Docker image to Container Registry
  - name: "gcr.io/cloud-builders/docker"
    args:
      - "push"
      - "gcr.io/$PROJECT_ID/consent-protocol:manual"
    id: "push-backend-image"

  - name: "gcr.io/cloud-builders/docker"
    args:
      - "push"
      - "gcr.io/$PROJECT_ID/consent-protocol:latest"
    id: "push-backend-latest"

  - name: "gcr.io/cloud-builders/docker"
    args:
      - "push"
      - "gcr.io/$PROJECT_ID/consent-protocol:v2.1.0"
    id: "push-backend-version"

  # Step 3: Deploy to Cloud Run
  - name: "gcr.io/google.com/cloudsdktool/cloud-sdk"
    entrypoint: gcloud
    args:
      - "run"
      - "deploy"
      - "consent-protocol"
      - "--image=gcr.io/$PROJECT_ID/consent-protocol:v2.1.0"
      - "--region=us-central1"
      - "--platform=managed"
      - "--allow-unauthenticated"
      - "--port=8080"
      - "--memory=1Gi"
      - "--cpu=1"
      - "--timeout=300"
      - "--max-instances=10"
      - "--min-instances=1"
      - "--set-env-vars=ENVIRONMENT=production,GOOGLE_GENAI_USE_VERTEXAI=True,DB_HOST=aws-1-us-east-1.pooler.supabase.com,DB_PORT=5432,DB_NAME=postgres"
      # Note: Update DB_HOST with your actual Supabase pooler host from Supabase Dashboard
      - "--set-secrets=SECRET_KEY=SECRET_KEY:latest,VAULT_ENCRYPTION_KEY=VAULT_ENCRYPTION_KEY:latest,GOOGLE_API_KEY=GOOGLE_API_KEY:latest,FIREBASE_SERVICE_ACCOUNT_JSON=FIREBASE_SERVICE_ACCOUNT_JSON:latest,FRONTEND_URL=FRONTEND_URL:latest,DB_USER=DB_USER:latest,DB_PASSWORD=DB_PASSWORD:latest"
      - "--add-cloudsql-instances=hushh-pda:us-central1:hushh-vault-db"
    id: "deploy-backend"

# Images to store in Container Registry
images:
  - "gcr.io/$PROJECT_ID/consent-protocol:manual"
  - "gcr.io/$PROJECT_ID/consent-protocol:latest"

# Build timeout
timeout: "1200s"

# Options
options:
  logging: CLOUD_LOGGING_ONLY
  machineType: "E2_HIGHCPU_8"

# Mobile Architecture (iOS/Android via Capacitor)

> Native mobile deployment with on-device consent protocol and future MLX LLM integration.

---

## ğŸ¯ Overview

The Hushh mobile architecture enables **offline-first, on-device data** while maintaining UI parity with the web application. The Next.js UI runs in a native WebView, while the consent protocol is implemented in Swift (iOS) and Kotlin (Android).

### Design Goals

```
"Same UI, native security, offline-first data, future on-device AI"
```

| Goal                 | Implementation                           |
| -------------------- | ---------------------------------------- |
| **UI Parity**        | Next.js static export in WKWebView       |
| **Consent Parity**   | Swift/Kotlin port of Python protocol     |
| **Offline-First**    | SQLCipher local vault, no cloud required |
| **Future MLX/Gemma** | Plugin architecture for on-device LLM    |

---

## ğŸ—ï¸ Architecture Diagram

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   CAPACITOR iOS/Android APP                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚           WKWebView (Next.js Static Export)              â”‚  â”‚
â”‚  â”‚  â€¢ React 19 + TailwindCSS UI (unchanged)                 â”‚  â”‚
â”‚  â”‚  â€¢ Morphy-UX components                                  â”‚  â”‚
â”‚  â”‚  â€¢ Client-side rendering only                            â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                          â†“ Capacitor.call()                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚        Swift Native Plugins (Consent Protocol)           â”‚  â”‚
â”‚  â”‚  â€¢ HushhConsentPlugin â†’ Token issue/validate/revoke      â”‚  â”‚
â”‚  â”‚  â€¢ HushhVaultPlugin   â†’ SQLCipher encrypted storage      â”‚  â”‚
â”‚  â”‚  â€¢ HushhKeychainPlugin â†’ iOS Keychain for secrets        â”‚  â”‚
â”‚  â”‚  â€¢ HushhLLMPlugin     â†’ MLX integration (Phase 2)        â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                          â†“                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚             Local Encrypted Storage                       â”‚  â”‚
â”‚  â”‚  â€¢ SQLCipher (AES-256 encrypted SQLite)                  â”‚  â”‚
â”‚  â”‚  â€¢ iOS Keychain (vault key + passphrase derivation)      â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“‚ File Structure

```
hushh-webapp/
â”œâ”€â”€ capacitor.config.ts       # iOS WebView configuration
â”œâ”€â”€ next.config.capacitor.ts  # Static export config for mobile
â”œâ”€â”€ package.json              # cap:build, cap:sync, cap:ios scripts
â”‚
â”œâ”€â”€ lib/capacitor/            # TypeScript Plugin Layer
â”‚   â”œâ”€â”€ index.ts              # Plugin registration
â”‚   â”œâ”€â”€ types.ts              # ConsentScope, HushhConsentToken, etc.
â”‚   â”œâ”€â”€ platform.ts           # isNative(), isIOS(), isWeb()
â”‚   â””â”€â”€ plugins/
â”‚       â”œâ”€â”€ consent-web.ts    # Web fallback (calls API routes)
â”‚       â”œâ”€â”€ vault-web.ts      # Web fallback (Web Crypto API)
â”‚       â””â”€â”€ keychain-web.ts   # Web fallback (sessionStorage)
â”‚
â””â”€â”€ ios/                      # Generated by `npx cap add ios`
    â””â”€â”€ App/
        â””â”€â”€ Plugins/          # Swift native plugins
            â”œâ”€â”€ HushhConsentPlugin/
            â”œâ”€â”€ HushhVaultPlugin/
            â””â”€â”€ HushhKeychainPlugin/
```

---

## ğŸ” Consent Protocol Parity

The Swift implementation must exactly match the Python consent protocol:

### Token Format

```
HCT:base64(userId|agentId|scope|issuedAt|expiresAt).hmac_sha256_signature
```

### Python â†’ Swift Mapping

| Python (consent-protocol)           | Swift (iOS Plugin)                            |
| ----------------------------------- | --------------------------------------------- |
| `hmac.new(SECRET_KEY, raw, sha256)` | `HMAC<SHA256>.authenticationCode(for:using:)` |
| `base64.urlsafe_b64encode()`        | `Data.base64EncodedString()`                  |
| `time.time() * 1000`                | `Date().timeIntervalSince1970 * 1000`         |
| `ConsentScope` enum                 | `ConsentScope` Swift enum                     |

### Encryption Parity

| Web (`lib/vault/encrypt.ts`)       | Swift (CryptoKit) |
| ---------------------------------- | ----------------- |
| `crypto.subtle.encrypt("AES-GCM")` | `AES.GCM.seal()`  |
| 12-byte IV                         | 12-byte nonce     |
| 128-bit auth tag                   | 128-bit tag       |
| Base64 encoding                    | Base64 encoding   |

---

## ğŸ’¾ Local Storage Architecture

### SQLCipher Database

```sql
-- Schema matches cloud PostgreSQL for sync compatibility
CREATE TABLE vault_food (
    user_id TEXT PRIMARY KEY,
    dietary_restrictions BLOB,  -- encrypted
    cuisine_preferences BLOB,   -- encrypted
    monthly_food_budget BLOB,   -- encrypted
    created_at INTEGER,
    updated_at INTEGER
);

CREATE TABLE consent_tokens (
    token_id TEXT PRIMARY KEY,
    user_id TEXT,
    agent_id TEXT,
    scope TEXT,
    issued_at INTEGER,
    expires_at INTEGER,
    revoked INTEGER DEFAULT 0
);
```

### Keychain Storage

| Key               | Purpose                        |
| ----------------- | ------------------------------ |
| `hushh_vault_key` | AES-256 vault encryption key   |
| `hushh_salt`      | PBKDF2 salt for key derivation |
| `hushh_user_id`   | Firebase user ID               |

---

## ğŸ“± Build Commands

```bash
# Development: Static export for Capacitor
npm run cap:build        # Build with next.config.capacitor.ts

# Sync to native projects
npm run cap:sync         # Copy web assets + sync plugins

# iOS development (requires macOS + Xcode)
npm run cap:ios          # Build, sync, and open Xcode
npm run cap:ios:run      # Build and run on simulator
```

---

## ğŸš€ Phase 2: MLX On-Device LLM

The plugin architecture supports future MLX integration:

```swift
// HushhLLMPlugin.swift (Phase 2)
import MLX
import MLXLLM

@objc func generateResponse(_ call: CAPPluginCall) {
    let prompt = call.getString("prompt") ?? ""
    Task {
        let response = try await LLMInference.generate(
            model: "gemma-2b-it-4bit",
            prompt: prompt
        )
        call.resolve(["response": response])
    }
}
```

### Model Recommendations

| Model          | Size   | RAM Required | Use Case                     |
| -------------- | ------ | ------------ | ---------------------------- |
| Gemma 2B 4-bit | ~1.5GB | 3-4GB        | Full agent capabilities      |
| Gemma 270M     | ~150MB | 1GB          | Lightweight intent detection |

---

## ğŸ”— Related Documentation

- [architecture.md](architecture.md) - Cloud system architecture
- [consent-implementation.md](consent-implementation.md) - Token lifecycle
- [frontend-design-system.md](frontend-design-system.md) - Morphy-UX components

---

_Version: 1.0 | Branch: feature/ios-capacitor | December 2025_

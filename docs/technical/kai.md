# Agent Kai: Deep Fundamental Analysis

> Comprehensive auditing and visualization of corporate fundamentals.
> Updated: January 2026.

---

## üéØ Overview

Agent Kai transforms from a basic data fetcher into a **Senior Quant Analyst**. It performs deep-dive audits on companies using SEC filings, market data, and qualitative analysis, presenting findings in a "Premium Institutional Terminal" interface.

## üìä Key Features

### 1. Context-Aware Personalization (NEW)

Kai now integrates with the **Hushh Investor Profile**.

- **Local Decryption**: The frontend decrypts the user's risk tolerance, investment style, and existing holdings locally.
- **Injected Context**: This context is passed to the analysis engine, allowing for personalized "Bull/Bear" cases. (e.g., "Given your Conservative profile, this high Beta stock poses a resilience risk.")

### 2. Streaming Debate Visualization (NEW)

Real-time SSE streaming of the multi-agent debate process:

- **Agent Progress**: Watch each agent (Fundamental, Sentiment, Valuation) analyze in sequence
- **Live Debate Rounds**: See agents debate and refine their positions in real-time
- **Full KPI Preservation**: All metrics, charts, and insights are returned after the debate
- **Graceful Error Handling**: Individual agent failures don't crash the entire analysis

### 3. Deep Fundamental Report

A structured, multi-section analysis generated by a specialized Multi-Agent Orchestrator:

- **Business Moat & Competitive Depth**: Analysis of sustainable competitive advantages.
- **Financial Resilience**: Stress-testing balance sheets against market volatility.
- **Capital Allocation**: Evaluating management's efficiency in deploying capital (ROIC, R&D).
- **Institutional Bull/Bear Cases**: Balanced, high-level arguments for and against the stock.

### 4. Advanced Visualizations

Interactive, multi-series charts powered by `recharts`:

- **Performance Trend**: Revenue vs. Operating Cash Flow (OCF) over time.
- **Growth & Innovation**: Revenue vs. R&D Spend to measure innovation efficiency.
- **Earnings Quality**: Net Income vs. OCF divergence check (Red flag detection).

### 5. Institutional Terminal UI

A premium, data-dense interface built with **Morphy-UX**:

- **Glassmorphism & Neomorphism**: Modern, depth-based UI elements.
- **GSAP Animations**: Smooth, cinematic entry animations for data cards.
- **Interactive Command Center**: Quick-scan interface for rapid ticker analysis.

---

## üèóÔ∏è Architecture

### Modular Route Structure

Kai API routes are organized in a modular package (`api/routes/kai/`):

```
api/routes/kai/
‚îú‚îÄ‚îÄ __init__.py       # Router aggregation
‚îú‚îÄ‚îÄ health.py         # /api/kai/health
‚îú‚îÄ‚îÄ consent.py        # /api/kai/consent/grant
‚îú‚îÄ‚îÄ analyze.py        # /api/kai/analyze (non-streaming)
‚îú‚îÄ‚îÄ stream.py         # /api/kai/analyze/stream (SSE)
‚îú‚îÄ‚îÄ decisions.py      # /api/kai/decision/* CRUD
‚îî‚îÄ‚îÄ preferences.py    # /api/kai/preferences/*
```

### AI Orchestrator (`hushh_mcp/agents/kai/orchestrator.py`)

Kai uses a **Debate Engine** approach where three specialists argue the case:

1. **Fundamental Agent**: Deep dives into SEC filings and financial ratios.
2. **Sentiment Agent**: Analyzes market narrative and catalyst flows.
3. **Valuation Agent**: Model building (DCF, Comps) and price target derivation.

The specialists reach a **Consensus** or document **Dissenting Opinions**, which are returned to the user via the `DecisionCard`.

### Backend Components

- **`FundamentalAgent`**: Orchestrates data fetching.
  - Fetches **Extended SEC Metrics**: OCF, Capex, Long-Term Debt, Equity, R&D.
  - Calculates **Deep Quant Metrics**: FCF Margin, Debt-to-Equity, Earnings Quality Ratio.
- **`DecisionGenerator`**: Synthesizes structured `DecisionCard`.
  - Promotes `quant_metrics` to top-level for frontend access.
  - Merges AI qualitative insights with deterministic financial data.

### Frontend (`app/dashboard/kai/analysis`)

- **`page.tsx`**: Main controller.
  - Manages `loading` states with `Loader2` spinner.
  - Restores and renders all key charts.
  - Retrieves `vaultOwnerToken` from `useVault()` for session-safe data access.

---

## üîê Consent & Security

Kai strictly adheres to the **Hushh Consent Protocol** with enhanced token-based compliance:

### Token-Based Access Control

- **VAULT_OWNER Token**: All user data reads require VAULT_OWNER token
  - Investor profile access: `getEncryptedProfile(vaultOwnerToken)`
  - Kai preferences access: Via VaultContext with token validation
  - Analysis history: Stored with token reference

- **Agent-Scoped Token**: Analysis operations use scoped tokens
  - Scope: `agent.kai.analyze`
  - Duration: 7 days (renewable)
  - Validated on every `/api/kai/analyze` request

- **Zero-Knowledge**: Personal holdings and profiles are only ever decrypted in the client's memory
- **Audit Trail**: Every analysis logged to `consent_audit` table with token reference

### Regulatory Compliance (SEC/FINRA)

#### Audit Trail for SEC Requirements

| SEC Requirement    | Hushh Implementation                                                                                                                                              |
| ------------------ | ----------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **Recordkeeping**  | Every Kai analysis logged to `consent_audit` with:<br/>- user_id<br/>- timestamp<br/>- ticker analyzed<br/>- VAULT_OWNER token used<br/>- decision card generated |
| **User Consent**   | Explicit token-based consent for each analysis operation                                                                                                          |
| **Fiduciary Duty** | Token system provides cryptographic proof of authorization                                                                                                        |
| **Audit Access**   | `consent_audit` table exportable for regulatory review                                                                                                            |
| **Retention**      | 2-year retention (SEC Rule 17a-4 compliance)                                                                                                                      |

#### VAULT_OWNER Token as Proof of Consent

Traditional robo-advisors use **implied consent** (user agreement buried in TOS).

**Hushh Kai uses cryptographic consent:**

```typescript
// Frontend: app/dashboard/kai/analysis/page.tsx
if (!vaultOwnerToken) {
  toast.error("Session expired. Please unlock vault again.");
  return; // Hard stop - no analysis without token
}

// Every analysis requires fresh token validation
const analysis = await analyzeFundamental({
  user_id: user.uid,
  ticker: targetTicker,
  token: vaultOwnerToken, // Cryptographic proof
  // ...
});
```

**Backend validation:**

```python
# consent-protocol/api/routes/kai.py
@router.post("/analyze")
async def analyze_ticker(request: AnalyzeRequest):
    # Validate VAULT_OWNER token before analysis
    token = request.token
    validate_vault_owner_token(token, request.user_id)

    # Log to audit trail
    await consent_db.insert_event(
        action="ANALYSIS_REQUESTED",
        user_id=request.user_id,
        token_id=token,
        metadata={"ticker": request.ticker}
    )

    # Perform analysis
    # ...
```

**Audit Trail Export for Regulators:**

```sql
-- Generate complete Kai usage report
SELECT
    timestamp,
    action,
    metadata->>'ticker' as ticker_analyzed,
    metadata->>'decision' as recommendation,
    token_id
FROM consent_audit
WHERE user_id = 'user123'
  AND agent_id = 'agent_kai'
ORDER BY timestamp DESC;
```

This provides:

- ‚úÖ **Proof of consent** for each analysis
- ‚úÖ **Complete audit trail** with timestamps
- ‚úÖ **Token-based authorization** (not implied)
- ‚úÖ **Regulatory export capability**

#### Comparison: Kai vs Traditional Robo-Advisors

| Aspect                     | Traditional Robo-Advisor            | Agent Kai                           |
| -------------------------- | ----------------------------------- | ----------------------------------- |
| **Consent Mechanism**      | Implied (TOS checkbox)              | Cryptographic tokens                |
| **Audit Trail**            | Internal logs (not user-accessible) | `consent_audit` table (exportable)  |
| **Access Control**         | Session-based (stateful)            | Token-based (stateless, verifiable) |
| **Regulatory Review**      | Request logs from company           | User exports own audit trail        |
| **Proof of Authorization** | "User agreed to TOS"                | Cryptographic token signature       |

---

## üöÄ Usage

### Running Analysis

1. Navigate to `/dashboard/kai/analysis`.
2. Enter a ticker (e.g., "AAPL", "NVDA").
3. Click "ANALYZE".
4. View the generated **Deep Fundamental Report**.

### Key Metrics Explained

- **Earnings Quality Ratio**: `OCF / Net Income`. >1.0 indicates high quality earnings backed by cash. <1.0 suggests accounting maneuvering.
- **Innovation Efficiency**: Revenue growth relative to R&D spend.

---

## üîí Deployment

- **Backend Service**: `consent-protocol` on Cloud Run.
- **Data Sources**: SEC EDGAR (primary), yfinance (market data).
